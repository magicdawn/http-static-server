#!/usr/bin/env node

'use strict';

/**
 * module dependencies
 */
const fs = require('fs');
const util = require('util');
const pathFn = require('path');
const Server = require('../server');
const open = require('open');

// parse argv
const argv = parseArgv();

// output help msg
if (argv.help) {
  return console.log(`
  Usage :

    http [options]

    -h|--help    帮助信息
    -p|--port    指定端口     默认随机端口
    -r|--root    指定根目录   默认当前目录

  `);
}


const s = new Server({
  port: argv.port,
  root: argv.root
});

s.listen().then(function(url) {
  process.title = 'localhost@' + s.server.address().port;
  console.log('http-static-server served at ' + url);

  // open the default browser
  open(url);
}).catch(console.error);


function parseArgv() {
  const ret = {};
  const args = process.argv.slice(2);
  if (!args) return ret;

  for (let i = 0; i < args.length; i++) {
    const arg = args[i];

    if (arg === '-h' || arg === '--help') {
      ret.help = true;
    } else if (arg === '--port' || arg === '-p') {
      ret.port = +(args[++i]);
      continue;
    } else if (arg === '-r' || arg === '--root') {
      ret.root = args[++i];
      continue;
    }
  }

  return ret;
}